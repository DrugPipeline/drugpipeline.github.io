---
import BaseLayout from '../layouts/BaseLayout.astro';
import NewsCard from '../components/NewsCard.astro';
import feedData from '../data/feeds.json';

interface FeedEntry {
  title: string;
  link: string;
  source: string;
  category: string;
  date: string;
  summary: string;
}

const entries = feedData as FeedEntry[];
const categories = ['all', ...new Set(entries.map((e) => e.category))];
const PAGE_SIZE = 20;
const totalPages = Math.ceil(entries.length / PAGE_SIZE);
---

<BaseLayout title="News â€” DrugPipeline" description="Latest pharma and biotech news from trusted sources.">
  <div class="flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">News</h1>
      <p class="mt-1 text-gray-600">Aggregated headlines from FDA, PubMed, STAT News, and more.</p>
    </div>
    <p class="text-sm text-gray-400">{entries.length} articles</p>
  </div>

  {/* Category filters */}
  <div class="mt-6 flex flex-wrap gap-2" role="group" aria-label="Filter by category" id="category-filters">
    {categories.map((cat) => (
      <button
        type="button"
        data-filter={cat}
        class:list={[
          'filter-btn rounded-full border px-4 py-1.5 text-sm font-medium transition-colors',
          cat === 'all'
            ? 'border-primary bg-primary text-white'
            : 'border-gray-300 text-gray-600 hover:border-gray-400',
        ]}
      >
        {cat.charAt(0).toUpperCase() + cat.slice(1)}
      </button>
    ))}
  </div>

  {/* News grid */}
  <div id="news-grid" class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    {entries.map((entry) => (
      <NewsCard {...entry} />
    ))}
  </div>

  {/* Empty state */}
  <p id="no-results" class="mt-8 hidden text-center text-gray-500">No articles found for this category.</p>

  {/* Pagination controls */}
  {totalPages > 1 && (
    <nav id="pagination" class="mt-8 flex items-center justify-center gap-2" aria-label="Pagination">
      <button
        type="button"
        id="prev-btn"
        class="rounded-md border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-600 transition-colors hover:border-gray-400 disabled:opacity-40"
        disabled
      >
        Previous
      </button>
      <span id="page-info" class="px-3 text-sm text-gray-500">Page 1 of {totalPages}</span>
      <button
        type="button"
        id="next-btn"
        class="rounded-md border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-600 transition-colors hover:border-gray-400 disabled:opacity-40"
      >
        Next
      </button>
    </nav>
  )}
</BaseLayout>

<script define:vars={{ PAGE_SIZE }}>
  const grid = document.getElementById('news-grid');
  const cards = Array.from(grid.children);
  const filters = document.getElementById('category-filters');
  const noResults = document.getElementById('no-results');
  const pagination = document.getElementById('pagination');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const pageInfo = document.getElementById('page-info');

  let activeCategory = 'all';
  let currentPage = 1;

  function getFiltered() {
    if (activeCategory === 'all') return cards;
    return cards.filter((c) => c.dataset.category === activeCategory);
  }

  function render() {
    const filtered = getFiltered();
    const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;

    cards.forEach((c) => c.classList.add('hidden'));
    filtered.forEach((c, i) => {
      if (i >= start && i < end) c.classList.remove('hidden');
    });

    noResults.classList.toggle('hidden', filtered.length > 0);

    if (pagination) {
      pagination.classList.toggle('hidden', totalPages <= 1);
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }
  }

  filters.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-filter]');
    if (!btn) return;

    filters.querySelectorAll('.filter-btn').forEach((b) => {
      b.classList.remove('border-primary', 'bg-primary', 'text-white');
      b.classList.add('border-gray-300', 'text-gray-600');
    });
    btn.classList.remove('border-gray-300', 'text-gray-600');
    btn.classList.add('border-primary', 'bg-primary', 'text-white');

    activeCategory = btn.dataset.filter;
    currentPage = 1;
    render();
  });

  if (prevBtn) prevBtn.addEventListener('click', () => { currentPage--; render(); });
  if (nextBtn) nextBtn.addEventListener('click', () => { currentPage++; render(); });

  render();
</script>
